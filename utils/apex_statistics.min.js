var conf = require("apex_statistics.config.js");
var systemInfos = {};
var pageUrl = "";

var scene = {
  "1001":"发现栏小程序主入口...",
  "1005":"搜索框的搜索结果页",
  "1006":"发现栏小程序主入口...",
  "1007":"单人聊天会话中的小...",
  "1008":"群聊会话中的小程序...",
  "1011":"扫描二维码",
  "1012":"长按图片识别二维码",
  "1013":"手机相册选取二维码",
  "1014":"小程序模板消息",
  "1017":"前往体验版的入口页",
  "1019":"微信钱包",
  "1020":"公众号profile页相...",
  "1022":"聊天顶部置顶小程序...",
  "1023":"安卓系统桌面图标",
  "1024":"小程序profile页",
  "1025":"扫描一维码",
  "1026":"附近小程序列表",
  "1027":"顶部搜索框搜索结果...",
  "1028":"我的卡包",
  "1029":"卡券详情页",
  "1030":"自动化测试下打开小...",
  "1031":"长按图片识别一维码",
  "1032":"手机相册选取一维码",
  "1034":"微信支付完成页",
  "1035":"公众号自定义菜单",
  "1036":"App分享消息卡片",
  "1037":"小程序打开小程序",
  "1038":"从另一个小程序返回",
  "1039":"摇电视",
  "1042":"添加好友搜索框的搜索...",
  "1043":"公众号模板消息",
  "1044":"带shareTicket的小程...",
  "1045":"朋友圈广告",
  "1046":"朋友圈广告详情页",
  "1047":"扫描小程序码",
  "1048":"长按图片识别小程序码",
  "1049":"手机相册选取小程序码",
  "1052":"卡券适用的门店列表",
  "1053":"搜一搜的结果页",
  "1054":"顶部搜索框的小程序...",
  "1056":"音乐播放器菜单",
  "1057":"钱包中的银行卡详情页",
  "1058":"公众号文章",
  "1059":"体验版小程序绑定邀请页",
  "1064":"微信脸Wi-Fi状态栏",
  "1067":"公众号文章广告",
  "1068":"附近小程序列表广告",
  "1069":"移动应用",
  "1071":"钱包中银行卡的列表页",
  "1072":"二维码收款页面",
  "1073":"客服消息列表下发的小...",
  "1074":"公众号会话下发的小程...",
  "1077":"摇周边",
  "1078":"链接Wi-Fi成功页",
  "1079":"微信游戏中心",
  "1081":"客服消息下发的文字链接",
  "1082":"公众号会话下发的文字链",
  "1084":"朋友圈广告原生页",
  "1089":"朋友圈主界面下拉,最...",
  "1090":"长按小程序有上角菜单...",
  "1091":"公众号文章商品卡片",
  "1092":"城市服务入口",
  "1095":"小程序广告组件",
  "1096":"聊天记录",
  "1097":"微信支付签约页",
  "1099":"页面内嵌插件",
  "1102":"公众号profile页服务预览",
  "1103":"发现栏小程序主入口...",
  "1104":"微信聊天主界面下拉..."
};
var Apex = {
	init: function() {
	  if(!conf.autoTrack) return;
		var N = App;

		App = function App(t) {
		  Apex.d(t, "onLaunch", (options) => {
		    Apex.resetFunc(options);
		  });
		  N(t);
		}
	},

	resetFunc: function(options) {
		systemInfos['pageSource'] = scene[options.scene];

		var M = Page;
		this.getDefaultSettings();

		Page = function Page(t) {
		  Apex.d(t, "onLoad", () => {
		    //绑定对应的点击事件
		      var currentPage = getCurrentPages()[getCurrentPages().length - 1];
          pageUrl = currentPage.route;
		      //获取PV
		      // Apex.getUserPV(currentPage.route);
		      let json = {};
		      for (let propOld in currentPage) {
		          if (typeof currentPage[propOld] == "function") {
		            json[propOld] = currentPage[propOld];
		            currentPage[propOld] = function(e) {
		            	Apex.userEventSplit(propOld, e);
		                (json[propOld]).apply(this, arguments);
		            }
		          }
		        }
		  });
		  M(t);
		}
	},
	//用户登录，获取appId
	getUserLogin: function(flag) {
	  let openId = wx.getStorageSync('_Apex_openid');
	  let unionid = wx.getStorageSync('_Apex_id');
	  if(!openId && !unionid) {
      wx.login({
        success: function(res) {
          if (res.code) {
            wx.request({
              url: 'https://api.weixin.qq.com/sns/jscode2session',
              data: {
                appid: conf.appId,
                secret: conf.appSecret,
                js_code: res.code,
                grant_type:　"authorization_code"
              },
              header: {
                'content-type': 'application/json'
              },
              success: function(ret) {
                let openid = ret.data.openid || "" //返回openid
                let unionid = ret.data.unionid || "" //返回unionid
                wx.setStorageSync('_Apex_id', unionid)
                wx.setStorageSync('_Apex_openid', openid)
                systemInfos["visitorId"] = openid; // 唯一标识
                systemInfos['unionid'] = unionid;
                if (openid != null && openid != undefined) {
                  wx.getUserInfo({
                    withCredentials: false,
                    success: function(res) {
                      console.log("获取" + res);
                    }
                  })
                }
                Apex.send();
              },
              fail: function () {
                var hasOpenId = wx.getStorageSync('openId') || '';
                systemInfos['visitorId'] = hasOpenId;
                systemInfos['unionid'] = '';
                Apex.send();
              }
            })
          } else {
            systemInfos["visitorId"] = '';
            systemInfos["unionid"] = '';
            Apex.send();
            console.log('登录失败！' + res.errMsg)
          }
        }
      });
    } else {
	    systemInfos['openid'] = openId;
	    systemInfos['unionid'] = unionid;
	    Apex.send();
    }

	},

	getDefaultSettings: function() {
		this.getUserLocation();
		this.getUserSystemInfo();
	},

	//获取用户当前设置
  getUserSetting: function() {
		//查看是否授权
		if (wx.getSetting) {
			wx.getSetting({
				success: function(res) {
					if (res.authSetting["scope.userInfo"]) {
						wx.getUserInfo({
							withCredentials: true,
							success: function(res) {
                systemInfos['country'] = res.userInfo.country || '',
                systemInfos['province'] = res.userInfo.province || '',
                systemInfos['city'] = res.userInfo.city || ''
							}
						});
					}
				},
				fail: function(error) {
					console.log(error);
				}
			})
		}
	},
	//获取用户系统信息
	getUserSystemInfo: function() {
		if (wx.getSystemInfo) {
			wx.getSystemInfo({
			  success: function(res) {
			  	systemInfos["os"] = res.system;//操作系统
			  	systemInfos["terminal"] = "smallwec";//终端类型
			  	systemInfos["language"] = res.language;//语言
			  	systemInfos["version"] = res.version || "";//微信版本号
			  }
			})
		} else {
		  console.log('获取用户系统失败')
    }
	},
	//获取用户系统信息同步,TODO
	getUserSystemInfoSync: function() {
		try {
		  var res = wx.getSystemInfoSync();
		} catch (e) {
		  // Do something when catch error
		  this.getUserSystemInfo();
		}
	},
	//获取当前位置
  // 备用
	getUserLocation: function() {
		wx.getLocation({
			type: "wgs84",
			success: function(res) {
				var latitude = res.latitude;
				var longitude = res.longitude;
			},
      fail: function () {
        console.error( '获取当前位置失败' );
      }
		});
	},
  // 获取浏览器时间
  getFormatTime: function () {
    var now = new Date();
    var year = now.getFullYear();
    var month = addZero(now.getMonth() + 1);
    var day = addZero(now.getDate());
    var hh = addZero(now.getHours());
    var mm = addZero(now.getMinutes());
    var ss = addZero(now.getSeconds());
    var dateArr = [year, month, day];
    var timeArr = [hh, mm, ss];
    var clock = dateArr.join('-');
    var clock1 = timeArr.join(':');
    clock += ' ' + clock1;
    return clock;

    // 在小于10的数字前加0
    function addZero(time) {
      return time < 10 ? '0' + time : time;
    }
  },
	sendEvent: function(event, functionName) {
    Apex.getUserLogin();
    if (!!event) {
      systemInfos['pageX'] = event.changedTouches ? Math.round(event.changedTouches[0].pageX) : '' || '';
      systemInfos['pageY'] = event.changedTouches ? Math.round(event.changedTouches[0].pageY) : '' || '';
      systemInfos['clientX'] = event.changedTouches ? Math.round(event.changedTouches[0].clientX) : '' || '';
      systemInfos['clientY'] = event.changedTouches ? Math.round(event.changedTouches[0].clientY) : '' || '';
      systemInfos['offsetLeft'] = event.currentTarget ? Math.round(event.currentTarget.offsetLeft) : '' || '';
      systemInfos['offsetTop'] = event.currentTarget ? Math.round(event.currentTarget.offsetTop) : '' || '';
      systemInfos['eventName'] = conf.event[functionName] ?
        (conf.event[functionName]["eventName"] ? conf.event[functionName]["eventName"] : "") : "Event";
      systemInfos['eventType'] = 'EVENT';
      if(!!conf.isProd) {
        console.log(systemInfos);
      }
    }
	},
	d: function(t, a, e) {
		if (t[a]) {
		    var s = t[a];
		    t[a] = function (t) {
		      e.call(this, t, a);
		      s.call(this, t);
		    };
		  } else {
		    t[a] = function (t) {
		      e.call(this, t, a);
		    };
		  }
	},

	userEventSplit: function(propOld, e) {
		if (propOld == "onReady") {
			//get PageUrl
      return;
		}

		if (propOld == "onShow") {
		  var currentPage = getCurrentPages()[getCurrentPages().length - 1];
      Apex.getUserPV(currentPage.route);
      return;
			// systemInfos["executionTime"] = Apex.getFormatTime();
        // TODO
    		// wx.setStorage({
    		// 	key: "currentPageStart",
    		// 	data: new Date().toString(),
    		// 	success: function(res){
    		// 		// console.log(res);
    		// 	}
    		// })
    	}

    	if (propOld == "onHide") {
    		wx.setStorage({
    			key: "currentPageEnd",
    			data: new Date().toString(),
    			success: function(res){
    			}
    		});
    		return;
    	}

		//TODO 分享功能
    // 	if (e && e.from && e.from == "menu") {
    // 		if (typeof wx["getShareInfo"] != "undefined") {
	  //           wx.getShareInfo({
	  //               shareTicket: opts.shareTicket,
	  //               success: function(res) {
	  //                   console.log(res);
	  //               },
	  //               fail: function(res) {
	  //                   console.log(res);
	  //               }
	  //           })
	  //       } else {
	  //       }
    // 	}

    	if (propOld == "onLaunch" || propOld == "onPageScroll"
        || propOld == "onPullDownRefresh" || propOld == "onReachBottom" || propOld == "onShareAppMessage") {
    		return;
    	}

    	if(!!e && Apex.checkObject(e) && !!e["currentTarget"]) {
        this.sendEvent(e,propOld);
      }
	},

  checkObject: function(obj) {
	  let flag = false;
	  for (let key in obj) {
	    flag = true;
	    break;
    }
    return flag;
  },

	getUserPV: function(pageUrl) {
    let pageName = pageUrl.split('?')[0];
    Apex.getUserLogin();
		systemInfos["eventType"] = "PV";
		systemInfos["eventName"] = conf.pv ? (conf.pv[pageName]? conf.pv[pageName] : "PV" ) : "PV";
    systemInfos['pageX'] = '';
    systemInfos['pageY'] = '';
    systemInfos['clientX']= '';
    systemInfos['clientY']= '';
    systemInfos['offsetLeft']= '';
    systemInfos['offsetTop']= '';
    // 生产环境输出
    if(!!conf.isProd) {
      console.log(systemInfos);
    }
	},

	send: function () {
    Apex.getUserSetting();
    var visitIdInfo = wx.getStorageSync('visitIdInfo');
    systemInfos['third'] = 'apex';
    systemInfos["pageUrl"] = pageUrl;
    systemInfos['cmpid'] = wx.getStorageSync('cmpid').value || '';
    systemInfos['inpid'] = wx.getStorageSync('inpid').value || '';
    systemInfos["referer"] = '';
    systemInfos["targetPath"] = "";
    systemInfos['userId'] = '';
    systemInfos['pvId'] = visitIdInfo.seq || '';
    systemInfos['visitId'] = visitIdInfo.visitId || '';
    systemInfos['screenWidth'] = wx.getSystemInfoSync().windowWidth || '';
    systemInfos['screenHeight'] = wx.getSystemInfoSync().windowHeight || '';
    systemInfos['executionTime'] = Apex.getFormatTime();
    // 发送请求
    wx.request({
      url: conf.server_url,
      data: systemInfos,
      header: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      method: "get",
      success: function() {},
      fail: function() {
        console.error( '网络请求失败' )
      }
    })
  }
};

module.exports = Apex;